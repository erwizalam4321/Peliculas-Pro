<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peliculas Pro - Your Ultimate Destination for Free HD Movie Streaming</title>
    <!-- Favicon: Using an SVG emoji for efficiency and relevance -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé¨</text></svg>">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom CSS for rainbow text in the header */
        .rainbow-text-header {
            background-image: linear-gradient(to right, violet, indigo, blue, green, yellow, orange, red);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 800;
        }
        /* CSS untuk menyembunyikan scrollbar tetapi tetap memungkinkan pengguliran */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Keyframes untuk animasi loading */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        /* Gaya untuk elemen loading */
        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* Gaya untuk genre badge */
        .genre-badge {
            display: inline-block;
            background-color: #2D3748; /* bg-gray-700 */
            color: #A0AEC0; /* text-gray-300 */
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* rounded-full */
            font-size: 0.875rem; /* text-sm */
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .genre-badge:hover {
            background-color: #4A5568; /* bg-gray-600 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-gray-800 shadow-lg py-4 px-6 md:px-10 flex flex-col md:flex-row items-center justify-between z-10 sticky top-0">
        <div class="flex items-center w-full md:w-auto justify-between md:justify-start mb-4 md:mb-0">
            <a href="#" class="text-3xl font-extrabold rainbow-text-header mr-6" id="home-link">Peliculas Pro</a>
            <!-- Dropdown for Mobile -->
            <div class="md:hidden">
                <button id="mobile-menu-button" class="text-white focus:outline-none">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-4 6h4"></path></svg>
                </button>
            </div>
        </div>

        <!-- Mobile Navigation Menu -->
        <nav id="mobile-navigation-menu" class="hidden md:hidden w-full text-center">
            <ul class="flex flex-col items-center space-y-4 py-4">
                <li>
                    <button id="mobile-movies-dropdown-btn" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-lg font-medium focus:outline-none">Movies</button>
                    <div id="mobile-movies-dropdown-menu" class="hidden flex flex-col mt-2 space-y-2 bg-gray-700 rounded-md p-2">
                        <button class="block px-4 py-2 text-md text-gray-200 hover:bg-gray-600 rounded-md" data-type="movie" data-category="now_playing">Now Playing</button>
                        <button class="block px-4 py-2 text-md text-gray-200 hover:bg-gray-600 rounded-md" data-type="movie" data-category="popular">Popular</button>
                        <button class="block px-4 py-2 text-md text-gray-200 hover:bg-gray-600 rounded-md" data-type="movie" data-category="top_rated">Top Rated</button>
                        <button class="block px-4 py-2 text-md text-gray-200 hover:bg-gray-600 rounded-md" data-type="movie" data-category="upcoming">Upcoming</button>
                    </div>
                </li>
                <li>
                    <button id="mobile-tv-shows-dropdown-btn" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-lg font-medium focus:outline-none">TV Shows</button>
                    <div id="mobile-tv-shows-dropdown-menu" class="hidden flex flex-col mt-2 space-y-2 bg-gray-700 rounded-md p-2">
                        <button class="block px-4 py-2 text-md text-gray-200 hover:bg-gray-600 rounded-md" data-type="tv" data-category="airing_today">Airing Today</button>
                        <button class="block px-4 py-2 text-md text-gray-200 hover:bg-gray-600 rounded-md" data-type="tv" data-category="on_the_air">On The Air</button>
                        <button class="block px-4 py-2 text-md text-gray-200 hover:bg-gray-600 rounded-md" data-type="tv" data-category="popular">Popular</button>
                        <button class="block px-4 py-2 text-md text-gray-200 hover:bg-gray-600 rounded-md" data-type="tv" data-category="top_rated">Top Rated</button>
                    </div>
                </li>
                <li>
                    <form id="mobile-search-form" class="w-full px-4">
                        <input type="text" id="mobile-search-input" placeholder="Search movies or TV shows..." class="w-full p-3 rounded-full bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </form>
                </li>
            </ul>
        </nav>

        <!-- Desktop Navigation Menu -->
        <nav class="hidden md:flex flex-grow justify-center items-center">
            <ul class="flex space-x-6 lg:space-x-10">
                <li class="relative group">
                    <button class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-lg font-medium focus:outline-none">Movies</button>
                    <div id="movies-dropdown-menu" class="absolute left-1/2 transform -translate-x-1/2 mt-2 w-48 bg-gray-700 rounded-md shadow-lg py-1 z-20 hidden group-hover:block">
                        <button class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 w-full text-left" data-type="movie" data-category="now_playing">Now Playing</button>
                        <button class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 w-full text-left" data-type="movie" data-category="popular">Popular</button>
                        <button class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 w-full text-left" data-type="movie" data-category="top_rated">Top Rated</button>
                        <button class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 w-full text-left" data-type="movie" data-category="upcoming">Upcoming</button>
                    </div>
                </li>
                <li class="relative group">
                    <button class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-lg font-medium focus:outline-none">TV Shows</button>
                    <div id="tv-shows-dropdown-menu" class="absolute left-1/2 transform -translate-x-1/2 mt-2 w-48 bg-gray-700 rounded-md shadow-lg py-1 z-20 hidden group-hover:block">
                        <button class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 w-full text-left" data-type="tv" data-category="airing_today">Airing Today</button>
                        <button class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 w-full text-left" data-type="tv" data-category="on_the_air">On The Air</button>
                        <button class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 w-full text-left" data-type="tv" data-category="popular">Popular</button>
                        <button class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 w-full text-left" data-type="tv" data-category="top_rated">Top Rated</button>
                    </div>
                </li>
            </ul>
        </nav>

        <!-- Search Bar (Desktop) -->
        <form id="search-form" class="hidden md:block w-full md:w-1/3 lg:w-1/4">
            <input type="text" id="search-input" placeholder="Search movies or TV shows..." class="w-full p-3 rounded-full bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </form>
    </header>

    <!-- Main Content Area -->
    <main id="content-area" class="flex-grow container mx-auto px-4 py-8">
        <!-- Content will be loaded here -->
    </main>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="animate-spin rounded-full h-32 w-32 border-b-4 border-blue-500"></div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 text-center py-6 mt-8">
        <p>&copy; 2024 Peliculas Pro. All rights reserved.</p>
        <p class="text-sm mt-2">Powered by The Movie Database (TMDB) API.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ** Perbaikan: Menggunakan URL proxy baru dan menghapus API Key **
            // Use the user-provided proxy URL directly.
            const BASE_URL = 'https://tmdb-api-proxy-1.musadekakhmad.workers.dev/3';
            const IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500';
            const BACKDROP_BASE_URL = 'https://image.tmdb.org/t/p/original';
            const PLACEHOLDER_IMG_URL = 'https://placehold.co/500x750?text=No+Image';

            // Element DOM
            const contentArea = document.getElementById('content-area');
            const homeLink = document.getElementById('home-link');
            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            const mobileSearchForm = document.getElementById('mobile-search-form');
            const mobileSearchInput = document.getElementById('mobile-search-input');
            const loadingSpinner = document.getElementById('loading-spinner');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileNavigationMenu = document.getElementById('mobile-navigation-menu');
            const mobileMoviesDropdownBtn = document.getElementById('mobile-movies-dropdown-btn');
            const mobileMoviesDropdownMenu = document.getElementById('mobile-movies-dropdown-menu');
            const mobileTvShowsDropdownBtn = document.getElementById('mobile-tv-shows-dropdown-btn');
            const mobileTvShowsDropdownMenu = document.getElementById('mobile-tv-shows-dropdown-menu');

            // Global State
            const state = {
                currentView: 'home', // 'home', 'list', 'details', 'search'
                listParams: null,    // { fetchType: 'category'/'genre', type: 'movie'/'tv', id: 'category_id'/'genre_id', title: 'Category/Genre Title' }
                detailsParams: null, // { type: 'movie'/'tv', id: 'item_id', title: 'Item Title' }
                searchQuery: null,   // The current search query
                currentPage: 1,      // Current page for lists
                totalPages: 1,       // Total pages available for current list
                renderedItemIds: new Set(), // To prevent duplicate cards on scroll
                isFetching: false,   // To prevent multiple fetches on scroll
                lastScrollTop: 0     // To detect scroll direction
            };

            // #############################################
            // UTILITY FUNCTIONS
            // #############################################

            const showLoading = () => {
                loadingSpinner.classList.remove('hidden');
            };

            const hideLoading = () => {
                loadingSpinner.classList.add('hidden');
            };

            // ** Perbaikan: Menambahkan penanganan error yang lebih baik di sini **
            const fetchApi = async (path, params = {}) => {
                showLoading();
                const urlParams = new URLSearchParams(params);
                try {
                    const response = await fetch(`${BASE_URL}${path}?${urlParams.toString()}`);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`HTTP error! status: ${response.status}`, errorText);
                        throw new Error(`API returned an error: ${response.status} - ${errorText}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error("Error fetching data:", error);
                    // Menampilkan pesan error yang ramah pengguna
                    contentArea.innerHTML = `<p class="text-red-500 text-center text-xl mt-10">Failed to load content. Please try again later. (Error: ${error.message})</p>`;
                    return null;
                } finally {
                    hideLoading();
                }
            };

            const createCardSkeleton = () => {
                const skeleton = document.createElement('div');
                skeleton.className = 'bg-gray-800 rounded-lg shadow-md overflow-hidden animate-pulse-slow';
                skeleton.innerHTML = `
                    <div class="bg-gray-700 w-full h-64 md:h-80 lg:h-96"></div>
                    <div class="p-4">
                        <div class="h-6 bg-gray-700 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-gray-700 rounded w-1/2"></div>
                    </div>
                `;
                return skeleton;
            };

            const renderCardSkeletons = (container, count) => {
                container.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    container.appendChild(createCardSkeleton());
                }
            };

            const clearContent = () => {
                contentArea.innerHTML = '';
                state.renderedItemIds.clear();
                state.currentPage = 1;
                state.totalPages = 1;
                state.listParams = null;
                state.detailsParams = null;
                state.searchQuery = null;
            };

            // #############################################
            // RENDERING FUNCTIONS
            // #############################################

            const renderCards = (items, container, append = false) => {
                if (!append) {
                    container.innerHTML = ''; // Clear existing cards if not appending
                    state.renderedItemIds.clear(); // Reset rendered IDs if starting fresh
                }

                items.forEach(item => {
                    const mediaType = item.media_type || (item.title ? 'movie' : 'tv');

                    if (state.renderedItemIds.has(item.id) || (mediaType !== 'movie' && mediaType !== 'tv')) {
                        return;
                    }
                    state.renderedItemIds.add(item.id);

                    const title = item.title || item.name;
                    const posterPath = item.poster_path;
                    const posterUrl = posterPath ? `${IMAGE_BASE_URL}${posterPath}` : PLACEHOLDER_IMG_URL;

                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300 cursor-pointer';
                    card.innerHTML = `
                        <img src="${posterUrl}" alt="Poster for ${title}" class="w-full h-auto object-cover">
                        <div class="p-4">
                            <h4 class="text-xl font-bold text-white truncate">${title}</h4>
                            <p class="text-sm text-gray-400 mt-1">Rating: ${item.vote_average.toFixed(1)}</p>
                        </div>
                    `;
                    card.addEventListener('click', () => {
                        // Use history.pushState for details page
                        const urlTitle = title.replace(/ /g, '-').toLowerCase().replace(/[^a-z0-9-]/g, ''); // Simple slug for cleaner URL
                        history.pushState(null, '', `/details/${mediaType}/${item.id}/${urlTitle}`);
                        updateState({ currentView: 'details', detailsParams: { type: mediaType, id: item.id, title: title } });
                    });
                    container.appendChild(card);
                });
            };

            const showHomePage = async () => {
                clearContent();
                state.currentView = 'home';
                contentArea.innerHTML = `
                    <h2 class="text-3xl font-bold text-white mb-6">Trending Movies & TV Shows</h2>
                    <div id="trending-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
                    <h2 class="text-3xl font-bold text-white mb-6 mt-10">Popular Movies</h2>
                    <div id="popular-movies-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
                    <h2 class="text-3xl font-bold text-white mb-6 mt-10">Popular TV Shows</h2>
                    <div id="popular-tv-shows-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
                `;

                const trendingContainer = document.getElementById('trending-container');
                const popularMoviesContainer = document.getElementById('popular-movies-container');
                const popularTvShowsContainer = document.getElementById('popular-tv-shows-container');

                renderCardSkeletons(trendingContainer, 12);
                renderCardSkeletons(popularMoviesContainer, 12);
                renderCardSkeletons(popularTvShowsContainer, 12);

                const [trendingData, popularMoviesData, popularTvShowsData] = await Promise.all([
                    fetchApi('/trending/all/week'),
                    fetchApi('/movie/popular'),
                    fetchApi('/tv/popular')
                ]);

                if (trendingData) renderCards(trendingData.results.slice(0, 12), trendingContainer);
                if (popularMoviesData) renderCards(popularMoviesData.results.slice(0, 12), popularMoviesContainer);
                if (popularTvShowsData) renderCards(popularTvShowsData.results.slice(0, 12), popularTvShowsContainer);
            };

            const showListingsPage = async (params) => {
                clearContent();
                state.currentView = 'list';
                state.listParams = params;

                contentArea.innerHTML = `
                    <h2 class="text-3xl font-bold text-white mb-6">${params.title}</h2>
                    <div id="listing-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
                    <div id="load-more-spinner" class="text-center py-4 hidden">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto"></div>
                    </div>
                `;

                const listingContainer = document.getElementById('listing-container');
                renderCardSkeletons(listingContainer, 20); // Render initial skeletons

                await fetchAndRenderList(listingContainer);
            };

            const fetchAndRenderList = async (container) => {
                if (state.isFetching || state.currentPage > state.totalPages) return;

                state.isFetching = true;
                const loadMoreSpinner = document.getElementById('load-more-spinner');
                if (loadMoreSpinner) loadMoreSpinner.classList.remove('hidden');

                let data;
                if (state.listParams.fetchType === 'category') {
                    data = await fetchApi(`/${state.listParams.type}/${state.listParams.id}`, { page: state.currentPage });
                } else if (state.listParams.fetchType === 'genre') {
                    // For genre, we use the discover endpoint
                    data = await fetchApi(`/discover/${state.listParams.type}`, {
                        with_genres: state.listParams.id,
                        page: state.currentPage
                    });
                }

                if (data && data.results) {
                    state.totalPages = data.total_pages;
                    renderCards(data.results, container, true); // Append cards
                    state.currentPage++;
                }
                state.isFetching = false;
                if (loadMoreSpinner) loadMoreSpinner.classList.add('hidden');
            };

            const showDetails = async (params) => {
                clearContent();
                state.currentView = 'details';
                state.detailsParams = params;
                contentArea.innerHTML = `
                    <div id="detail-container" class="bg-gray-800 rounded-lg shadow-xl p-6 lg:flex lg:items-start lg:space-x-8">
                        <!-- Skeletons for details -->
                        <div class="lg:w-1/3 flex-shrink-0">
                            <div class="bg-gray-700 w-full h-96 rounded-lg animate-pulse-slow"></div>
                        </div>
                        <div class="lg:w-2/3 mt-6 lg:mt-0">
                            <div class="h-10 bg-gray-700 rounded w-3/4 mb-4 animate-pulse-slow"></div>
                            <div class="h-6 bg-gray-700 rounded w-1/2 mb-4 animate-pulse-slow"></div>
                            <div class="h-4 bg-gray-700 rounded w-full mb-2 animate-pulse-slow"></div>
                            <div class="h-4 bg-gray-700 rounded w-full mb-2 animate-pulse-slow"></div>
                            <div class="h-4 bg-gray-700 rounded w-5/6 mb-6 animate-pulse-slow"></div>
                            <div class="h-8 bg-gray-700 rounded w-1/4 mb-4 animate-pulse-slow"></div>
                            <div class="h-6 bg-gray-700 rounded w-1/3 mb-2 animate-pulse-slow"></div>
                            <div class="h-6 bg-gray-700 rounded w-1/4 animate-pulse-slow"></div>
                        </div>
                    </div>
                `;

                const detailContainer = document.getElementById('detail-container');
                const data = await fetchApi(`/${params.type}/${params.id}`, { append_to_response: 'credits,videos,recommendations' });

                if (!data) {
                    return;
                }

                const title = data.title || data.name;
                const posterPath = data.poster_path;
                const posterUrl = posterPath ? `${IMAGE_BASE_URL}${posterPath}` : PLACEHOLDER_IMG_URL;
                const backdropPath = data.backdrop_path;
                const backdropUrl = backdropPath ? `${BACKDROP_BASE_URL}${backdropPath}` : '';

                // Extract director (for movies) or creator (for TV)
                let directorOrCreator = 'N/A';
                if (params.type === 'movie' && data.credits && data.credits.crew) {
                    const director = data.credits.crew.find(person => person.job === 'Director');
                    if (director) directorOrCreator = director.name;
                } else if (params.type === 'tv' && data.created_by && data.created_by.length > 0) {
                    directorOrCreator = data.created_by.map(creator => creator.name).join(', ');
                }

                // Get main trailer/teaser
                let trailerUrl = '';
                if (data.videos && data.videos.results.length > 0) {
                    const trailer = data.videos.results.find(video => video.type === 'Trailer' && video.site === 'YouTube') ||
                                    data.videos.results.find(video => video.type === 'Teaser' && video.site === 'YouTube') ||
                                    data.videos.results.find(video => video.site === 'YouTube'); // Fallback to any YouTube video
                    if (trailer) {
                        trailerUrl = `https://www.youtube.com/embed/${trailer.key}`;
                    }
                }

                detailContainer.style.backgroundImage = backdropUrl ? `linear-gradient(rgba(17, 24, 39, 0.9), rgba(17, 24, 39, 0.9)), url(${backdropUrl})` : 'none';
                detailContainer.style.backgroundSize = 'cover';
                detailContainer.style.backgroundPosition = 'center';
                detailContainer.style.backgroundRepeat = 'no-repeat';

                detailContainer.innerHTML = `
                    <div class="lg:w-1/3 flex-shrink-0">
                        <img src="${posterUrl}" alt="Poster for ${title}" class="w-full h-auto rounded-lg shadow-lg">
                    </div>
                    <div class="lg:w-2/3 mt-6 lg:mt-0">
                        <h2 class="text-4xl font-extrabold text-white mb-2">${title}</h2>
                        <p class="text-lg text-gray-300 mb-4">${data.tagline || ''}</p>

                        <div class="flex items-center space-x-4 mb-4">
                            <p class="text-xl font-bold text-yellow-400">‚≠ê ${data.vote_average ? data.vote_average.toFixed(1) : 'N/A'}</p>
                            <p class="text-md text-gray-400">${params.type === 'movie' ? (data.release_date ? data.release_date.substring(0, 4) : 'N/A') : (data.first_air_date ? data.first_air_date.substring(0, 4) : 'N/A')}</p>
                            ${data.runtime ? `<p class="text-md text-gray-400">${Math.floor(data.runtime / 60)}h ${data.runtime % 60}m</p>` : ''}
                            ${data.number_of_seasons ? `<p class="text-md text-gray-400">${data.number_of_seasons} Seasons</p>` : ''}
                        </div>

                        <p class="text-gray-300 leading-relaxed mb-6">${data.overview}</p>

                        <div class="mb-6">
                            <h3 class="text-xl font-semibold text-white mb-2">Genres:</h3>
                            <div id="genre-badges" class="flex flex-wrap gap-2">
                                ${data.genres.map(genre => `<span class="genre-badge cursor-pointer" data-genre-id="${genre.id}" data-genre-name="${genre.name}">${genre.name}</span>`).join('')}
                            </div>
                        </div>

                        <div class="mb-6">
                            <p class="text-md text-gray-300"><strong>${params.type === 'movie' ? 'Director' : 'Creator'}:</strong> ${directorOrCreator}</p>
                            <p class="text-md text-gray-300"><strong>Status:</strong> ${data.status}</p>
                            ${data.spoken_languages && data.spoken_languages.length > 0 ? `<p class="text-md text-gray-300"><strong>Language:</strong> ${data.spoken_languages[0].english_name}</p>` : ''}
                        </div>

                        ${trailerUrl ? `
                            <div class="mb-8">
                                <h3 class="text-2xl font-bold text-white mb-4">Trailer:</h3>
                                <div class="aspect-video w-full rounded-lg overflow-hidden shadow-lg">
                                    <iframe src="${trailerUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-full"></iframe>
                                </div>
                            </div>
                        ` : ''}

                        <div id="cast-container" class="mb-8">
                            <h3 class="text-2xl font-bold text-white mb-4">Top Cast:</h3>
                            <div class="flex overflow-x-auto no-scrollbar pb-4 space-x-4">
                                ${data.credits && data.credits.cast.length > 0 ?
                                    data.credits.cast.slice(0, 10).map(cast => `
                                        <div class="flex-none text-center w-24">
                                            <img src="${cast.profile_path ? `${IMAGE_BASE_URL.replace('w500', 'w200')}${cast.profile_path}` : 'https://placehold.co/200x300?text=No+Image'}" alt="${cast.name}" class="w-20 h-20 rounded-full object-cover mx-auto mb-2 border-2 border-gray-600">
                                            <p class="text-sm text-gray-300 font-semibold truncate">${cast.name}</p>
                                            <p class="text-xs text-gray-400 truncate">${cast.character}</p>
                                        </div>
                                    `).join('')
                                    : '<p class="text-gray-400">No cast information available.</p>'
                                }
                            </div>
                        </div>

                        <div id="recommendations-container">
                            <h3 class="text-2xl font-bold text-white mb-4">More Like This:</h3>
                            <div id="recommendation-cards" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                                ${data.recommendations && data.recommendations.results.length > 0 ?
                                    data.recommendations.results.slice(0, 12).map(rec => {
                                        const recTitle = rec.title || rec.name;
                                        const recPosterUrl = rec.poster_path ? `${IMAGE_BASE_URL.replace('w500', 'w200')}${rec.poster_path}` : 'https://placehold.co/200x300?text=No+Image';
                                        const recMediaType = rec.media_type || (rec.title ? 'movie' : 'tv');
                                        const recUrlTitle = recTitle.replace(/ /g, '-').toLowerCase().replace(/[^a-z0-9-]/g, '');

                                        return `
                                            <div class="bg-gray-800 rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300 cursor-pointer recommendation-card"
                                                 data-type="${recMediaType}" data-id="${rec.id}" data-title="${recTitle}">
                                                <img src="${recPosterUrl}" alt="Poster for ${recTitle}" class="w-full h-auto object-cover">
                                                <div class="p-2">
                                                    <h4 class="text-md font-bold text-white truncate">${recTitle}</h4>
                                                    <p class="text-xs text-gray-400 mt-1">Rating: ${rec.vote_average.toFixed(1)}</p>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')
                                    : '<p class="text-gray-400">No recommendations available.</p>'
                                }
                            </div>
                        </div>
                    </div>
                `;

                // Add event listeners for genre badges
                document.querySelectorAll('.genre-badge').forEach(badge => {
                    badge.addEventListener('click', (e) => {
                        const genreId = e.target.dataset.genreId;
                        const genreName = e.target.dataset.genreName;
                        const urlGenreName = genreName.replace(/ /g, '-').toLowerCase().replace(/[^a-z0-9-]/g, ''); // Simple slug
                        history.pushState(null, '', `/genre/${params.type}/${genreId}/${urlGenreName}`);
                        updateState({ currentView: 'list', listParams: { fetchType: 'genre', type: params.type, id: genreId, title: `Genre: ${genreName}` }, currentPage: 1 });
                    });
                });

                // Add event listeners for recommendation cards
                document.querySelectorAll('.recommendation-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const recType = e.currentTarget.dataset.type;
                        const recId = e.currentTarget.dataset.id;
                        const recTitle = e.currentTarget.dataset.title;
                        const recUrlTitle = recTitle.replace(/ /g, '-').toLowerCase().replace(/[^a-z0-9-]/g, '');
                        history.pushState(null, '', `/details/${recType}/${recId}/${recUrlTitle}`);
                        updateState({ currentView: 'details', detailsParams: { type: recType, id: recId, title: recTitle } });
                    });
                });
            };

            const showSearchResults = async (query) => {
                clearContent();
                state.currentView = 'search';
                state.searchQuery = query;

                contentArea.innerHTML = `
                    <h2 class="text-3xl font-bold text-white mb-6">Search results for "${query}"</h2>
                    <div id="search-results-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
                    <div id="load-more-spinner" class="text-center py-4 hidden">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto"></div>
                    </div>
                `;

                const searchResultsContainer = document.getElementById('search-results-container');
                renderCardSkeletons(searchResultsContainer, 20); // Render initial skeletons

                await fetchAndRenderSearchResults(searchResultsContainer);
            };

            const fetchAndRenderSearchResults = async (container) => {
                if (state.isFetching || state.currentPage > state.totalPages) return;

                state.isFetching = true;
                const loadMoreSpinner = document.getElementById('load-more-spinner');
                if (loadMoreSpinner) loadMoreSpinner.classList.remove('hidden');

                const data = await fetchApi('/search/multi', { query: state.searchQuery, page: state.currentPage });

                if (data && data.results) {
                    state.totalPages = data.total_pages;
                    renderCards(data.results.filter(item => item.media_type === 'movie' || item.media_type === 'tv'), container, true); // Append cards
                    state.currentPage++;
                }
                state.isFetching = false;
                if (loadMoreSpinner) loadMoreSpinner.classList.add('hidden');
            };

            // #############################################
            // STATE MANAGEMENT
            // #############################################

            const updateState = (newState) => {
                Object.assign(state, newState);
                renderView();
            };

            const renderView = () => {
                switch (state.currentView) {
                    case 'home':
                        showHomePage();
                        break;
                    case 'list':
                        showListingsPage(state.listParams);
                        break;
                    case 'details':
                        showDetails(state.detailsParams);
                        break;
                    case 'search':
                        showSearchResults(state.searchQuery);
                        break;
                    default:
                        showHomePage();
                        break;
                }
            };

            // #############################################
            // ROUTING & EVENT LISTENERS
            // #############################################

            const handleHistoryChange = () => {
                const path = window.location.pathname;
                const pathSegments = path.slice(1).split('/'); // Remove leading slash and split

                // Default to home if path is empty or just '/'
                if (!pathSegments[0] || pathSegments[0] === '') {
                    updateState({ currentView: 'home' });
                    return;
                }

                const [view, type, id, ...titleParts] = pathSegments;
                // Join back parts and replace hyphens with spaces for the title
                const title = titleParts.join(' ').replace(/-/g, ' ');

                switch(view) {
                    case 'content':
                        updateState({
                            currentView: 'list',
                            listParams: { fetchType: 'category', type, id, title },
                            currentPage: 1
                        });
                        break;
                    case 'details':
                        updateState({
                            currentView: 'details',
                            detailsParams: { type, id, title },
                            currentPage: 1 // Reset page for details view
                        });
                        break;
                    case 'genre':
                        updateState({
                            currentView: 'list',
                            listParams: { fetchType: 'genre', type, id, title: `Genre: ${title}` },
                            currentPage: 1
                        });
                        break;
                    case 'search':
                        // Use the URL segment directly for the search query, as spaces are replaced with hyphens
                        const searchQueryFromUrl = type.replace(/-/g, ' ');
                        updateState({
                            currentView: 'search',
                            searchQuery: searchQueryFromUrl,
                            currentPage: 1
                        });
                        break;
                    default:
                        updateState({ currentView: 'home' });
                        break;
                }
            };

            // Mobile menu toggle
            mobileMenuButton.addEventListener('click', () => {
                mobileNavigationMenu.classList.toggle('hidden');
            });

            mobileMoviesDropdownBtn.addEventListener('click', () => {
                mobileMoviesDropdownMenu.classList.toggle('hidden');
                mobileTvShowsDropdownMenu.classList.add('hidden'); // Close other dropdown
            });

            mobileTvShowsDropdownBtn.addEventListener('click', () => {
                mobileTvShowsDropdownMenu.classList.toggle('hidden');
                mobileMoviesDropdownMenu.classList.add('hidden'); // Close other dropdown
            });

            homeLink.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent default link behavior
                history.pushState(null, '', '/'); // Push root state
                updateState({ currentView: 'home' }); // Manually update state
            });

            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const query = searchInput.value;
                if (query) {
                    const urlQuery = query.replace(/ /g, '-').toLowerCase().replace(/[^a-z0-9-]/g, '');
                    history.pushState(null, '', `/search/${urlQuery}`);
                    updateState({ currentView: 'search', searchQuery: query }); // Use original query for actual search
                }
            });

            mobileSearchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const query = mobileSearchInput.value;
                if (query) {
                    const urlQuery = query.replace(/ /g, '-').toLowerCase().replace(/[^a-z0-9-]/g, '');
                    history.pushState(null, '', `/search/${urlQuery}`);
                    updateState({ currentView: 'search', searchQuery: query });
                    mobileNavigationMenu.classList.add('hidden'); // Hide mobile menu after search
                }
            });

            document.querySelectorAll('#movies-dropdown-menu button, #mobile-movies-dropdown-menu button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const type = e.target.dataset.type;
                    const category = e.target.dataset.category;
                    const title = `${e.target.textContent} Movies`;
                    const urlTitle = title.replace(/ /g, '-').toLowerCase().replace(/[^a-z0-9-]/g, '');
                    history.pushState(null, '', `/content/${type}/${category}/${urlTitle}`);
                    updateState({ currentView: 'list', listParams: { fetchType: 'category', type, id: category, title }, currentPage: 1 });
                    mobileNavigationMenu.classList.add('hidden'); // Hide mobile menu
                });
            });

            document.querySelectorAll('#tv-shows-dropdown-menu button, #mobile-tv-shows-dropdown-menu button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const type = e.target.dataset.type;
                    const category = e.target.dataset.category;
                    const title = `${e.target.textContent} Tv Shows`;
                    const urlTitle = title.replace(/ /g, '-').toLowerCase().replace(/[^a-z0-9-]/g, '');
                    history.pushState(null, '', `/content/${type}/${category}/${urlTitle}`);
                    updateState({ currentView: 'list', listParams: { fetchType: 'category', type, id: category, title }, currentPage: 1 });
                    mobileNavigationMenu.classList.add('hidden'); // Hide mobile menu
                });
            });

            // Infinite scrolling for listings and search results
            window.addEventListener('scroll', () => {
                if (state.currentView === 'list' || state.currentView === 'search') {
                    const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
                    const isScrollingDown = scrollTop > state.lastScrollTop;
                    state.lastScrollTop = scrollTop;

                    // Load more when scrolled to bottom and scrolling down
                    if (isScrollingDown && (scrollTop + clientHeight >= scrollHeight - 200) && !state.isFetching && state.currentPage <= state.totalPages) {
                        const container = state.currentView === 'list' ? document.getElementById('listing-container') : document.getElementById('search-results-container');
                        if (container) { // Ensure container exists before fetching
                            if (state.currentView === 'list') {
                                fetchAndRenderList(container);
                            } else if (state.currentView === 'search') {
                                fetchAndRenderSearchResults(container);
                            }
                        }
                    }
                }
            });

            // Initial load based on current path
            handleHistoryChange();

            // Listen for popstate event (browser back/forward buttons)
            window.addEventListener('popstate', handleHistoryChange);
        });
    </script>
</body>
</html>
