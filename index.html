<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peliculas Pro - Your Ultimate Destination for Free HD Movie Streaming</title>
    <!-- Favicon: Using an SVG emoji for efficiency and relevance -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ¬</text></svg>">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom CSS for rainbow text in the header */
        .rainbow-text-header {
            background-image: linear-gradient(to right, violet, indigo, blue, green, yellow, orange, red);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 800;
        }
        /* CSS untuk membuat header menjadi sticky */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 50; /* Pastikan header berada di atas konten lain saat digulir */
        }
    </style>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Welcome to Peliculas Pro, the best free movie streaming platform online. Watch thousands of HD movies, from new releases to timeless classics, with no subscription required. Your ultimate source for unlimited entertainment.">
    <meta name="keywords" content="Peliculas Pro, free movies, watch movies online, HD streaming, latest movies, popular movies, no subscription, free entertainment, online cinema, movie streaming site">
    <link rel="canonical" href="https://peliculaspro.netlify.app/">

    <!-- Open Graph & Twitter Meta Tags for social media sharing -->
    <meta property="og:title" content="Peliculas Pro - Free HD Movie Streaming">
    <meta property="og:description" content="The best free movie streaming platform. Watch thousands of HD movies for free.">
    <meta property="og:image" content="https://live.staticflickr.com/65535/54698621370_1b976fbd76_b.jpg">
    <meta property="og:url" content="https://peliculaspro.netlify.app/">
    <meta property="og:type" content="website">
    <meta property="fb:app_id" content="100074345305108">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:site" content="@ErwizalA84074">
    <meta property="twitter:title" content="Peliculas Pro - Free HD Movie Streaming">
    <meta property="twitter:description" content="The best free movie streaming platform. Watch thousands of HD movies for free.">

</head>
<body class="bg-gray-900 text-gray-200">
    <!-- Header and Navigation -->
    <!-- Menambahkan class 'sticky-header' untuk membuat header tetap di atas saat scroll -->
    <header class="bg-gray-800 shadow-md sticky-header">
        <!-- New container to match the width of the main content -->
        <div class="container mx-auto px-4 max-w-7xl">
            <nav class="p-4 flex flex-col md:flex-row justify-between items-center">
                <a href="#" id="home-link" class="flex items-center mb-4 md:mb-0">
                    <!-- Movie Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-400 mr-3" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18 3H6c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM6 5h12v14H6V5zm10 12h-2v-2h2v2zM8 7h2v2H8V7zm0 4h2v2H8v-2zm0 4h2v2H8v-2zm4-4h2v2h-2v-2zm0 4h2v2h-2v-2zm4-4h2v2h-2v-2z"/>
                    </svg>
                    <span class="rainbow-text-header text-3xl md:text-4xl">Peliculas Pro</span>
                </a>
                <!-- Navigation links, dropdowns, and search bar -->
                <div class="flex items-center space-x-4">
                    <a href="#" class="text-white hover:text-red-500 hover:font-bold transition-colors duration-300">Home</a>
                    <div class="relative group">
                        <button id="movies-dropdown-button" class="text-white hover:text-blue-500 hover:font-bold transition-colors duration-300 flex items-center">
                            Movies
                            <svg class="h-4 w-4 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div id="movies-dropdown-menu" class="absolute opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 bg-gray-700 text-white rounded-lg shadow-lg mt-2 py-2 z-10 w-48">
                            <button class="block w-full text-left px-4 py-2 hover:bg-gray-600" data-category="popular" data-type="movie">Popular</button>
                            <button class="block w-full text-left px-4 py-2 hover:bg-gray-600" data-category="now_playing" data-type="movie">Now Playing</button>
                            <button class="block w-full text-left px-4 py-2 hover:bg-gray-600" data-category="upcoming" data-type="movie">Upcoming</button>
                            <button class="block w-full text-left px-4 py-2 hover:bg-gray-600" data-category="top_rated" data-type="movie">Top Rated</button>
                        </div>
                    </div>
                    <div class="relative group">
                        <button id="tv-shows-dropdown-button" class="text-white hover:text-yellow-400 transition-colors duration-300 flex items-center">
                            Tv Shows
                            <svg class="h-4 w-4 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div id="tv-shows-dropdown-menu" class="absolute opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 bg-gray-700 text-white rounded-lg shadow-lg mt-2 py-2 z-10 w-48">
                            <button class="block w-full text-left px-4 py-2 hover:bg-gray-600" data-category="popular" data-type="tv">Popular</button>
                            <button class="block w-full text-left px-4 py-2 hover:bg-gray-600" data-category="airing_today" data-type="tv">Airing Today</button>
                            <button class="block w-full text-left px-4 py-2 hover:bg-gray-600" data-category="on_the_air" data-type="tv">On TV</button>
                            <button class="block w-full text-left px-4 py-2 hover:bg-gray-600" data-category="top_rated" data-type="tv">Top Rated</button>
                        </div>
                    </div>
                    <!-- Search Form -->
                    <form id="search-form" class="flex items-center">
                        <input type="text" id="search-input" placeholder="Search movies or TV shows..." class="px-3 py-1 text-sm rounded-l-full bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 w-40 md:w-auto">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-r-full shadow-lg transition-colors duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </button>
                    </form>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Main Banner Image -->
        <div id="hero-section" class="mb-8 rounded-lg overflow-hidden shadow-lg">
            <img src="https://live.staticflickr.com/65535/54698621370_1b976fbd76_b.jpg" alt="Peliculas Pro Movie Streaming Banner" class="w-full h-auto">
        </div>

        <!-- Main Heading -->
        <h1 id="main-heading" class="text-3xl md:text-4xl font-extrabold text-white mb-6 leading-tight flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-yellow-400 mr-4 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18 3H6c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM6 5h12v14H6V5zm10 12h-2v-2h2v2zM8 7h2v2H8V7zm0 4h2v2H8v-2zm0 4h2v2H8v-2zm4-4h2v2h-2v-2zm0 4h2v2h-2v-2zm4-4h2v2h-2v-2z"/>
            </svg>
            Welcome to Peliculas Pro: Your Ultimate Destination for the Best Free Movie Streaming
        </h1>

        <!-- Introduction Section -->
        <p id="intro-section" class="text-lg mb-8 text-gray-300 text-justify">
            Welcome to Peliculas Pro, a revolutionary platform designed specifically for cinema lovers seeking a high-quality movie watching experience at no cost. In today's digital age, where entertainment is an inseparable part of daily life, Peliculas Pro serves as an advanced solution to meet your needs. We understand how valuable your free time is, and we are committed to providing unlimited access to thousands of films across various genres, from the latest Hollywood blockbusters to timeless classics. With a constantly updated collection and a user-friendly interface, Peliculas Pro is not just a streaming site but a community for those passionate about the seventh art.
        </p>
        
        <!-- Placeholder for dynamic content -->
        <div id="content-area"></div>
    </main>

    <!-- Footer Section -->
    <footer class="bg-gray-800 text-center text-gray-400 p-4 mt-12">
        <p>&copy; 2024 Peliculas Pro. All rights reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // #############################################
            // API KEY CONFIGURATION (UPDATED)
            // #############################################
            // A list of available API keys/proxies. The application will try the first one,
            // and if it fails, it will fall back to the next one.
            const apiKeys = [
                'tmdb-api-proxy.argoyuwono119.workers.dev',
                'tmdb-api-proxy.musadekakhmad.workers.dev',
                'tmdb-api-proxy-1.musadekakhmad.workers.dev'
            ];
            
            // #############################################
            // CENTRALIZED STATE MANAGEMENT
            // #############################################

            const contentArea = document.getElementById('content-area');
            const heroSection = document.getElementById('hero-section');
            const introSection = document.getElementById('intro-section');
            const mainHeading = document.getElementById('main-heading');
            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            const homeLink = document.getElementById('home-link');

            const state = {
                currentPage: 1,
                renderedItemIds: new Set(),
                currentView: 'home', // 'home', 'list', 'details', 'search'
                listParams: null, // { fetchType, type, id, title }
                detailsParams: null, // { type, id, title }
                searchQuery: null,
            };

            const updateState = (newState) => {
                Object.assign(state, newState);
                render();
            };

            const render = () => {
                heroSection.classList.add('hidden');
                introSection.classList.add('hidden');
                mainHeading.classList.add('hidden');
                contentArea.innerHTML = '';
                
                state.renderedItemIds.clear();

                switch (state.currentView) {
                    case 'home':
                        heroSection.classList.remove('hidden');
                        introSection.classList.remove('hidden');
                        mainHeading.classList.remove('hidden');
                        mainHeading.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-yellow-400 mr-4 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18 3H6c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM6 5h12v14H6V5zm10 12h-2v-2h2v2zM8 7h2v2H8V7zm0 4h2v2H8v-2zm0 4h2v2H8v-2zm4-4h2v2h-2v-2zm0 4h2v2h-2v-2zm4-4h2v2h-2v-2z"/>
                            </svg>
                            Welcome to Peliculas Pro: Your Ultimate Destination for the Best Free Movie Streaming
                        `;
                        break;
                    case 'list':
                        showDynamicContent(state.listParams.fetchType, state.listParams.type, state.listParams.id, state.listParams.title);
                        break;
                    case 'details':
                        showDetails(state.detailsParams.type, state.detailsParams.id, state.detailsParams.title);
                        break;
                    case 'search':
                        showSearchResults(state.searchQuery);
                        break;
                }
            };
            
            // #############################################
            // UTILITY FUNCTIONS & API CALLS
            // #############################################
            // Function to perform a fetch with fallback if an API key fails
            const safeFetch = async (urlSuffix, options = {}) => {
                for (const apiKey of apiKeys) {
                    const url = `https://${apiKey}${urlSuffix}`;
                    try {
                        const response = await fetch(url, options);
                        if (response.ok) {
                            return response.json();
                        }
                    } catch (error) {
                        console.warn(`Failed to fetch from ${apiKey}. Trying next API key.`, error);
                    }
                }
                throw new Error('All API keys failed to fetch data.');
            };

            const fetchContent = async (type, category, page = 1) => {
                const urlSuffix = `/${type}/${category}?page=${page}`;
                try {
                    const data = await safeFetch(urlSuffix);
                    return data.results;
                } catch (error) {
                    console.error('Error fetching data:', error);
                    return [];
                }
            };
            
            const fetchByGenre = async (type, genreId, page = 1) => {
                const urlSuffix = `/discover/${type}?with_genres=${genreId}&page=${page}`;
                try {
                    const data = await safeFetch(urlSuffix);
                    return data.results;
                } catch (error) {
                    console.error('Error fetching data by genre:', error);
                    return [];
                }
            };

            const fetchSearchResults = async (query) => {
                const urlSuffix = `/search/multi?query=${encodeURIComponent(query)}`;
                try {
                    const data = await safeFetch(urlSuffix);
                    return data.results;
                } catch (error) {
                    console.error('Error fetching search results:', error);
                    return [];
                }
            };

            const renderCards = (items, container) => {
                items.forEach(item => {
                    const mediaType = item.media_type || (item.title ? 'movie' : 'tv');

                    if (state.renderedItemIds.has(item.id) || (mediaType !== 'movie' && mediaType !== 'tv')) {
                        return;
                    }
                    state.renderedItemIds.add(item.id);

                    const title = item.title || item.name;
                    const posterPath = item.poster_path;
                    const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w500/${posterPath}` : 'https://placehold.co/500x750?text=No+Image';

                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300 cursor-pointer';
                    card.innerHTML = `
                        <img src="${posterUrl}" alt="Poster for ${title}" class="w-full h-auto object-cover">
                        <div class="p-4">
                            <h4 class="text-xl font-bold text-white truncate">${title}</h4>
                            <p class="text-sm text-gray-400 mt-1">Rating: ${item.vote_average.toFixed(1)}</p>
                        </div>
                    `;

                    // Update the click handler to use history.pushState for cleaner URLs
                    card.addEventListener('click', () => {
                        // Ganti spasi dengan tanda hubung sebelum encoding
                        const cleanTitle = title.replace(/ /g, '-');
                        const newUrl = `/details/${mediaType}/${item.id}/${encodeURIComponent(cleanTitle)}`;
                        history.pushState(null, '', newUrl);
                        updateState({
                            currentView: 'details',
                            detailsParams: { type: mediaType, id: item.id, title: title },
                        });
                    });

                    container.appendChild(card);
                });
            };

            const showDynamicContent = async (fetchType, type, id, title) => {
                mainHeading.innerHTML = `<h2 class="text-3xl md:text-4xl font-extrabold text-white mb-6">${title}</h2>`;
                mainHeading.classList.remove('hidden');

                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6';
                
                let items;
                if (fetchType === 'category') {
                    items = await fetchContent(type, id, state.currentPage);
                } else if (fetchType === 'genre') {
                    items = await fetchByGenre(type, id, state.currentPage);
                }

                if (items && items.length > 0) {
                    contentArea.appendChild(itemsContainer);
                    renderCards(items, itemsContainer);

                    const loadMoreButton = document.createElement('button');
                    loadMoreButton.className = 'mt-8 mx-auto block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform duration-300 transform hover:scale-105';
                    loadMoreButton.textContent = 'Load More';
                    
                    loadMoreButton.addEventListener('click', async () => {
                        updateState({ currentPage: state.currentPage + 1 });
                        let moreItems;
                        if (fetchType === 'category') {
                            moreItems = await fetchContent(type, id, state.currentPage);
                        } else if (fetchType === 'genre') {
                            moreItems = await fetchByGenre(type, id, state.currentPage);
                        }

                        if (moreItems && moreItems.length > 0) {
                            renderCards(moreItems, itemsContainer);
                        } else {
                            loadMoreButton.textContent = 'No More Items';
                            loadMoreButton.disabled = true;
                        }
                    });
                    contentArea.appendChild(loadMoreButton);
                } else {
                    contentArea.innerHTML = '<p class="text-center text-gray-500">No content found.</p>';
                }
            };

            const showSearchResults = async (query) => {
                const decodedQuery = decodeURIComponent(query).replace(/-/g, ' '); // Ganti kembali tanda hubung ke spasi
                mainHeading.innerHTML = `<h2 class="text-3xl md:text-4xl font-extrabold text-white mb-6">Search Results for: "${decodedQuery}"</h2>`;
                mainHeading.classList.remove('hidden');

                const searchResults = await fetchSearchResults(decodedQuery);
                if (searchResults && searchResults.length > 0) {
                    const itemsContainer = document.createElement('div');
                    itemsContainer.className = 'grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6';
                    contentArea.appendChild(itemsContainer);
                    renderCards(searchResults, itemsContainer);
                } else {
                    contentArea.innerHTML = '<p class="text-center text-gray-500">No results found for your search.</p>';
                }
            };
            
            const showDetails = async (type, id, titleFromHash) => {
                const loadingSpinner = document.createElement('div');
                loadingSpinner.className = 'flex justify-center items-center h-64';
                loadingSpinner.innerHTML = `
                    <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
                `;
                contentArea.appendChild(loadingSpinner);

                try {
                    const [details, videosData, creditsData, similarData, reviewsData] = await Promise.all([
                        safeFetch(`/${type}/${id}`),
                        safeFetch(`/${type}/${id}/videos`),
                        safeFetch(`/${type}/${id}/credits`),
                        safeFetch(`/${type}/${id}/similar`),
                        safeFetch(`/${type}/${id}/reviews`)
                    ]);
                    
                    loadingSpinner.remove();

                    const backButton = document.createElement('button');
                    backButton.className = 'bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-300 mb-6';
                    backButton.innerHTML = 'â† Back';
                    backButton.addEventListener('click', () => history.back());
                    contentArea.appendChild(backButton);
                    
                    const trailer = videosData.results.find(video => video.type === 'Trailer' && video.site === 'YouTube');
                    const director = creditsData.crew.find(member => member.job === 'Director');
                    const cast = creditsData.cast.slice(0, 5).map(actor => actor.name).join(', ');
                    const similarItems = similarData.results.slice(0, 6);
                    const reviews = reviewsData.results.slice(0, 5);

                    const detailContainer = document.createElement('div');
                    detailContainer.className = 'grid grid-cols-1 md:grid-cols-3 gap-8';

                    const posterPath = details.poster_path;
                    const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w500/${posterPath}` : 'https://placehold.co/500x750?text=No+Image';

                    // Modifikasi: Selalu tampilkan judul asli jika tersedia
                    const originalTitle = details.original_title;

                    let genreLinks = '';
                    if (details.genres && details.genres.length > 0) {
                        genreLinks = details.genres.map(g => `<span class="genre-link cursor-pointer text-blue-400 hover:text-blue-200 hover:underline" data-genre-id="${g.id}" data-genre-name="${g.name}">${g.name}</span>` ).join(', ');
                    } else {
                        genreLinks = 'N/A';
                    }

                    detailContainer.innerHTML = `
                        <div class="md:col-span-1">
                            <img src="${posterUrl}" alt="Poster for ${details.title || details.name}" class="rounded-lg shadow-xl w-full">
                        </div>
                        <div class="md:col-span-2">
                            <h1 class="text-5xl font-extrabold text-white mb-2">${details.title || details.name}</h1>
                            ${originalTitle ? `<h2 class="text-xl text-gray-400 mb-4 italic">${originalTitle}</h2>` : ''}
                            <p class="text-yellow-400 font-bold text-xl mb-4">Rating: ${details.vote_average.toFixed(1)}/10</p>
                            <p class="text-gray-300 mb-4 text-justify">${details.overview || 'No overview available.'}</p>
                            <div class="space-y-2 mb-6">
                                <p class="text-gray-400"><span class="font-bold text-white">Genre:</span> ${genreLinks}</p>
                                <p class="text-gray-400"><span class="font-bold text-white">Release Date:</span> ${details.release_date || details.first_air_date || 'N/A'}</p>
                                <p class="text-gray-400"><span class="font-bold text-white">Director:</span> ${director ? director.name : 'N/A'}</p>
                                <p class="text-gray-400"><span class="font-bold text-white">Main Cast:</span> ${cast || 'N/A'}</p>
                            </div>

                            ${trailer ? `
                                <div class="mb-6">
                                    <h3 class="text-2xl font-bold text-white mb-3">Trailer</h3>
                                    <div class="aspect-w-16 aspect-h-9 overflow-hidden rounded-lg shadow-lg">
                                        <iframe class="w-full h-full" src="https://www.youtube.com/embed/${trailer.key}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                    </div>
                                </div>
                            ` : ''}

                            <div id="reviews-section">
                                <h3 class="text-2xl font-bold text-white mb-3">Reviews</h3>
                                ${reviews.length > 0 ? reviews.map(review => `
                                    <div class="bg-gray-700 p-4 rounded-lg shadow-md mb-4">
                                        <p class="font-bold text-white">${review.author}</p>
                                        <p class="text-gray-400 text-sm italic">Rating: ${review.author_details.rating ? `${review.author_details.rating}/10` : 'N/A'}</p>
                                        <p class="text-gray-300 mt-2">${review.content.substring(0, 300)}...</p>
                                    </div>
                                `).join('') : '<p class="text-gray-500">No reviews available.</p>'}
                            </div>
                        </div>
                    `;
                    contentArea.appendChild(detailContainer);

                    // Similar movies section
                    if (similarItems.length > 0) {
                        const similarContainer = document.createElement('div');
                        similarContainer.className = 'mt-12';
                        similarContainer.innerHTML = `
                            <h3 class="text-3xl font-bold text-white mb-6">Similar ${type === 'movie' ? 'Movies' : 'TV Shows'}</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6" id="similar-content-area"></div>
                        `;
                        contentArea.appendChild(similarContainer);
                        renderCards(similarItems, document.getElementById('similar-content-area'));
                    }
                    
                    // Add event listeners for genre links
                    document.querySelectorAll('.genre-link').forEach(link => {
                        link.addEventListener('click', (e) => {
                            const genreId = e.target.dataset.genreId;
                            const genreName = e.target.dataset.genreName;
                            // Ganti spasi dengan tanda hubung sebelum encoding
                            const cleanGenreName = genreName.replace(/ /g, '-');
                            const newUrl = `/genre/${type}/${genreId}/${encodeURIComponent(cleanGenreName)}`;
                            history.pushState(null, '', newUrl);
                            updateState({
                                currentPage: 1,
                                currentView: 'list',
                                listParams: { fetchType: 'genre', type: type, id: genreId, title: `Genre: ${genreName}` }
                            });
                        });
                    });

                } catch (error) {
                    loadingSpinner.remove();
                    contentArea.innerHTML = `<p class="text-center text-red-500">Error: ${error.message}</p>`;
                }
            };

            // #############################################
            // URL HANDLING (UPDATED)
            // #############################################

            const handleUrlChange = () => {
                const path = window.location.pathname;
                const pathSegments = path.split('/').filter(segment => segment);
                
                // Root URL
                if (pathSegments.length === 0) {
                    updateState({ currentView: 'home' });
                    return;
                }
                
                const view = pathSegments[0];

                switch (view) {
                    case 'content':
                        if (pathSegments.length >= 4) {
                            const [view, type, category, title] = pathSegments;
                            // Ganti tanda hubung dengan spasi
                            const decodedTitle = decodeURIComponent(title).replace(/-/g, ' ');
                            updateState({
                                currentPage: 1,
                                currentView: 'list',
                                listParams: { fetchType: 'category', type: type, id: category, title: decodedTitle }
                            });
                        }
                        break;
                    case 'genre':
                        if (pathSegments.length >= 4) {
                            const [view, type, genreId, genreName] = pathSegments;
                             // Ganti tanda hubung dengan spasi
                            const decodedGenreName = decodeURIComponent(genreName).replace(/-/g, ' ');
                             updateState({
                                currentPage: 1,
                                currentView: 'list',
                                listParams: { fetchType: 'genre', type: type, id: genreId, title: `Genre: ${decodedGenreName}` }
                            });
                        }
                        break;
                    case 'details':
                        if (pathSegments.length >= 4) {
                            const [view, type, id, title] = pathSegments;
                             // Ganti tanda hubung dengan spasi
                            const decodedTitle = decodeURIComponent(title).replace(/-/g, ' ');
                            updateState({
                                currentView: 'details',
                                detailsParams: { type: type, id: id, title: decodedTitle },
                            });
                        }
                        break;
                    case 'search':
                        if (pathSegments.length >= 2) {
                            const [view, query] = pathSegments;
                            // Ganti tanda hubung dengan spasi
                            const decodedQuery = decodeURIComponent(query).replace(/-/g, ' ');
                            updateState({
                                currentView: 'search',
                                searchQuery: decodedQuery
                            });
                        }
                        break;
                    default:
                        // Handle unknown paths, maybe redirect to home
                        history.pushState(null, '', '/');
                        updateState({ currentView: 'home' });
                        break;
                }
            };
            
            // #############################################
            // EVENT LISTENERS (UPDATED)
            // #############################################

            // Home link click listener
            homeLink.addEventListener('click', (e) => {
                e.preventDefault();
                history.pushState(null, '', '/');
                updateState({ currentView: 'home' });
            });
            
            // Search form submission listener
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const query = searchInput.value.trim();
                if (query) {
                    // Ganti spasi dengan tanda hubung sebelum encoding
                    const cleanQuery = query.replace(/ /g, '-');
                    const newUrl = `/search/${encodeURIComponent(cleanQuery)}`;
                    history.pushState(null, '', newUrl);
                    updateState({
                        currentView: 'search',
                        searchQuery: query
                    });
                }
            });

            // Movies dropdown menu click listeners
            document.querySelectorAll('#movies-dropdown-menu button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const type = e.target.dataset.type;
                    const category = e.target.dataset.category;
                    const title = `${e.target.textContent} Movies`;
                    // Ganti spasi dengan tanda hubung sebelum encoding
                    const cleanTitle = title.replace(/ /g, '-');
                    const newUrl = `/content/${type}/${category}/${encodeURIComponent(cleanTitle)}`;
                    history.pushState(null, '', newUrl);
                    updateState({
                        currentPage: 1,
                        currentView: 'list',
                        listParams: { fetchType: 'category', type: type, id: category, title: title }
                    });
                });
            });

            // TV Shows dropdown menu click listeners
            document.querySelectorAll('#tv-shows-dropdown-menu button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const type = e.target.dataset.type;
                    const category = e.target.dataset.category;
                    const title = `${e.target.textContent} TV Shows`;
                     // Ganti spasi dengan tanda hubung sebelum encoding
                    const cleanTitle = title.replace(/ /g, '-');
                    const newUrl = `/content/${type}/${category}/${encodeURIComponent(cleanTitle)}`;
                    history.pushState(null, '', newUrl);
                    updateState({
                        currentPage: 1,
                        currentView: 'list',
                        listParams: { fetchType: 'category', type: type, id: category, title: title }
                    });
                });
            });

            // Listen for browser back/forward buttons
            window.addEventListener('popstate', handleUrlChange);

            // Initial page load based on URL path
            handleUrlChange();
        });
    </script>
</body>
</html>
